"use strict";function integralImage(im,w,h){var sum,sum2,i,j,k,y,g,imLen=im.length,count=w*h,gray=new Array8U(count),integral=new Array32F(count),squares=new Array32F(count),tilted=new Array32F(count);for(j=0,i=0,sum=sum2=0;j<w;)g=4899*im[i]+9617*im[i+1]+1868*im[i+2]+8192>>>14,sum+=g&=255,sum2+=g*g,gray[j]=g,integral[j]=sum,squares[j]=sum2,tilted[j]=g,j++,i+=4;for(k=0,y=1,j=w,i=w<<2,sum=sum2=0;i<imLen;)g=4899*im[i]+9617*im[i+1]+1868*im[i+2]+8192>>>14,sum+=g&=255,sum2+=g*g,gray[j]=g,integral[j]=integral[j-w]+sum,squares[j]=squares[j-w]+sum2,tilted[j]=tilted[j+1-w]+(g+gray[j-w])+(y>1?tilted[j-w-w]:0)+(k>0?tilted[j-1-w]:0),j++,i+=4,++k>=w&&(k=0,y++,sum=sum2=0);return{gray:gray,integral:integral,squares:squares,tilted:tilted}}function integralCanny(gray,w,h){var i,j,k,sum,grad_x,grad_y,ind0,ind1,ind2,ind_1,ind_2,count=gray.length,lowpass=new Array8U(count),canny=new Array32F(count);for(i=0;i<w;i++)lowpass[i]=0,lowpass[i+w]=0,lowpass[i+count-w]=0,lowpass[i+count-w-w]=0,canny[i]=0,canny[i+count-w]=0;for(j=0,k=0;j<h;j++,k+=w)lowpass[0+k]=0,lowpass[1+k]=0,lowpass[w-1+k]=0,lowpass[w-2+k]=0,canny[0+k]=0,canny[w-1+k]=0;for(i=2;i<w-2;i++)for(sum=0,j=2,k=w<<1;j<h-2;j++,k+=w)ind2=(ind1=(ind0=i+k)+w)+w,sum=0+(gray[(ind_2=(ind_1=ind0-w)-w)-2]<<1)+(gray[ind_1-2]<<2)+(gray[ind0-2]<<2)+gray[ind0-2]+(gray[ind1-2]<<2)+(gray[ind2-2]<<1)+(gray[ind_2-1]<<2)+(gray[ind_1-1]<<3)+gray[ind_1-1]+(gray[ind0-1]<<4)-(gray[ind0-1]<<2)+(gray[ind1-1]<<3)+gray[ind1-1]+(gray[ind2-1]<<2)+(gray[ind_2]<<2)+gray[ind_2]+(gray[ind_1]<<4)-(gray[ind_1]<<2)+(gray[ind0]<<4)-gray[ind0]+(gray[ind1]<<4)-(gray[ind1]<<2)+(gray[ind2]<<2)+gray[ind2]+(gray[ind_2+1]<<2)+(gray[ind_1+1]<<3)+gray[ind_1+1]+(gray[ind0+1]<<4)-(gray[ind0+1]<<2)+(gray[ind1+1]<<3)+gray[ind1+1]+(gray[ind2+1]<<2)+(gray[ind_2+2]<<1)+(gray[ind_1+2]<<2)+(gray[ind0+2]<<2)+gray[ind0+2]+(gray[ind1+2]<<2)+(gray[ind2+2]<<1),lowpass[ind0]=((103*sum+8192&4294967295)>>>14&255)>>>0;for(i=1;i<w-1;i++)for(j=1,k=w;j<h-1;j++,k+=w)ind1=(ind0=k+i)+w,grad_x=0-lowpass[(ind_1=ind0-w)-1]+lowpass[ind_1+1]-lowpass[ind0-1]-lowpass[ind0-1]+lowpass[ind0+1]+lowpass[ind0+1]-lowpass[ind1-1]+lowpass[ind1+1],grad_y=0+lowpass[ind_1-1]+lowpass[ind_1]+lowpass[ind_1]+lowpass[ind_1+1]-lowpass[ind1-1]-lowpass[ind1]-lowpass[ind1]-lowpass[ind1+1],canny[ind0]=Abs(grad_x)+Abs(grad_y);for(i=0,sum=0;i<w;)sum+=canny[i],canny[i]=sum,i++;for(i=w,k=0,sum=0;i<count;)sum+=canny[i],canny[i]=canny[i-w]+sum,i++,++k>=w&&(k=0,sum=0);return canny}function merge(rects,min_neighbors,ratio,selection){var neighbors,r,i,j,n,t,ri,rlen=rects.length,ref=new Array(rlen),feats=[],nb_classes=0,found=!1;for(i=0;i<rlen;i++)ref[i]=0;for(i=0;i<rlen;i++){for(found=!1,j=0;j<i;j++)rects[j].almostEqual(rects[i])&&(found=!0,ref[i]=ref[j]);found||(ref[i]=nb_classes,nb_classes++)}for(neighbors=new Array(nb_classes),r=new Array(nb_classes),i=0;i<nb_classes;i++)neighbors[i]=0,r[i]=new Feature;for(i=0;i<rlen;i++)neighbors[ri=ref[i]]++,r[ri].add(rects[i]);for(i=0;i<nb_classes;i++)(n=neighbors[i])>=min_neighbors&&(ri=new Feature((t=1/(n+n))*(2*r[i].x+n),t*(2*r[i].y+n),t*(2*r[i].width+n),t*(2*r[i].height+n)),feats.push(ri));for(1!=ratio&&(ratio=1/ratio),rlen=feats.length,i=0;i<rlen;i++)for(j=i+1;j<rlen;j++)!feats[i].isInside&&feats[i].inside(feats[j])?feats[i].isInside=!0:!feats[j].isInside&&feats[j].inside(feats[i])&&(feats[j].isInside=!0);for(i=rlen;--i>=0;)feats[i].isInside?feats.splice(i,1):(1!=ratio&&feats[i].scale(ratio),feats[i].round().computeArea());return feats.sort(byArea)}function byArea(a,b){return a.area-b.area}function byOrder(a,b){return a.index-b.index}function mergeSteps(d){return d[1].length&&(d[0]=d[0].concat(d[1]).sort(byOrder)),d[0]}function detectSingleStep(self){var xstep,ystep,xsize,ysize,x,y,ty,tyw,tys,p0,p1,p2,p3,xl,yl,s,bx2,by2,inv_area,total_x,vnorm,edges_density,pass,stage,threshold,trees,tl,t,cur_node_ind,features,feature,rects,nb_rects,thresholdf,rect_sum,kr,r,x1,y1,x2,y2,x3,y3,x4,y4,sum,Sqrt=Sqrt||Math.sqrt,ret=[],haar=self.haardata,haar_stages=haar.stages,scaledSelection=self.scaledSelection,w=scaledSelection.width,h=scaledSelection.height,imArea=w*h,imArea1=imArea-1,sizex=haar.size1,sizey=haar.size2,startx=scaledSelection.x,starty=scaledSelection.y,sl=haar_stages.length,cL=self.cannyLow,cH=self.cannyHigh,canny=self.canny,integral=self.integral,squares=self.squares,tilted=self.tilted,scale=self.scale,increment=self.increment,index=self.i||0,doCanny=self.doCannyPruning;for(0,bx2=w-1,0,by2=imArea-w,xstep=~~((xsize=~~(scale*sizex))*increment),tyw=(ysize=~~(scale*sizey))*w,xl=w-xsize,yl=h-ysize,inv_area=1/(xsize*ysize),y=starty,ty=starty*(tys=(ystep=~~(ysize*increment))*w);y<yl;y+=ystep,ty+=tys)for(x=startx;x<xl;x+=xstep)if(p0=x-1+ty-w,p1=p0+xsize,p2=p0+tyw,p3=p2+xsize,p0=p0<0?0:p0>imArea1?imArea1:p0,p1=p1<0?0:p1>imArea1?imArea1:p1,p2=p2<0?0:p2>imArea1?imArea1:p2,p3=p3<0?0:p3>imArea1?imArea1:p3,!doCanny||!((edges_density=inv_area*(canny[p3]-canny[p2]-canny[p1]+canny[p0]))<cL||edges_density>cH)){for(total_x=inv_area*(integral[p3]-integral[p2]-integral[p1]+integral[p0]),vnorm=(vnorm=inv_area*(squares[p3]-squares[p2]-squares[p1]+squares[p0])-total_x*total_x)>1?Sqrt(vnorm):1,pass=!0,s=0;s<sl;s++){for(threshold=(stage=haar_stages[s]).thres,tl=(trees=stage.trees).length,sum=0,t=0;t<tl;t++)for(features=trees[t].feats,cur_node_ind=0;;){if(feature=features[cur_node_ind],rects=feature.rects,nb_rects=rects.length,thresholdf=feature.thres,rect_sum=0,feature.tilt)for(kr=0;kr<nb_rects;kr++)x1=x+~~(scale*(r=rects[kr])[0]),y1=(y-1+~~(scale*r[1]))*w,x2=x+~~(scale*(r[0]+r[2])),y2=(y-1+~~(scale*(r[1]+r[2])))*w,x3=x+~~(scale*(r[0]-r[3])),y3=(y-1+~~(scale*(r[1]+r[3])))*w,x4=x+~~(scale*(r[0]+r[2]-r[3])),y4=(y-1+~~(scale*(r[1]+r[2]+r[3])))*w,x1=x1<0?0:x1>bx2?bx2:x1,x2=x2<0?0:x2>bx2?bx2:x2,x3=x3<0?0:x3>bx2?bx2:x3,x4=x4<0?0:x4>bx2?bx2:x4,y1=y1<0?0:y1>by2?by2:y1,y2=y2<0?0:y2>by2?by2:y2,y3=y3<0?0:y3>by2?by2:y3,y4=y4<0?0:y4>by2?by2:y4,rect_sum+=r[4]*(tilted[x4+y4]-tilted[x3+y3]-tilted[x2+y2]+tilted[x1+y1]);else for(kr=0;kr<nb_rects;kr++)x1=x-1+~~(scale*(r=rects[kr])[0]),x2=x-1+~~(scale*(r[0]+r[2])),y1=w*(y-1+~~(scale*r[1])),y2=w*(y-1+~~(scale*(r[1]+r[3]))),x1=x1<0?0:x1>bx2?bx2:x1,x2=x2<0?0:x2>bx2?bx2:x2,y1=y1<0?0:y1>by2?by2:y1,y2=y2<0?0:y2>by2?by2:y2,rect_sum+=r[4]*(integral[x2+y2]-integral[x1+y2]-integral[x2+y1]+integral[x1+y1]);if(rect_sum*inv_area<thresholdf*vnorm?0:1){if(feature.has_r){sum+=feature.r_val;break}cur_node_ind=feature.r_node}else{if(feature.has_l){sum+=feature.l_val;break}cur_node_ind=feature.l_node}}if(!(pass=sum>threshold))break}pass&&ret.push({index:index,x:x,y:y,width:xsize,height:ysize})}return ret}function detectEnd(self,rects){for(var i=0,l=rects.length;i<l;i++)rects[i]=new Feature(rects[i]);self.objects=merge(rects,self.min_neighbors,self.Ratio,self.Selection),self.Ready=!0,self.onComplete&&self.onComplete.call(self)}var HAAR={VERSION:"@@VERSION@@"},Detector,Feature,proto="prototype",undef=void 0,Array32F="undefined"!=typeof Float32Array?Float32Array:Array,Array8U="undefined"!=typeof Uint8Array?Uint8Array:Array,Abs=Math.abs,Max=Math.max,Min=Math.min,Floor=Math.floor,Round=Math.round,Sqrt=Math.sqrt,slice=Array[proto].slice;(Detector=HAAR.Detector=function(haardata,Parallel){var self=this;self.haardata=haardata||null,self.Ready=!1,self.doCannyPruning=!1,self.Canvas=null,self.Selection=null,self.scaledSelection=null,self.objects=null,self.TimeInterval=null,self.DetectInterval=30,self.Ratio=.5,self.cannyLow=20,self.cannyHigh=100,self.Parallel=Parallel||null,self.onComplete=null})[proto]={constructor:Detector,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var self=this;return self.DetectInterval&&clearTimeout(self.DetectInterval),self.DetectInterval=null,self.TimeInterval=null,self.haardata=null,self.Canvas=null,self.objects=null,self.Selection=null,self.scaledSelection=null,self.Ratio=null,self.origWidth=null,self.origHeight=null,self.width=null,self.height=null,self.doCannyPruning=null,self.cannyLow=null,self.cannyHigh=null,self.canny=null,self.integral=null,self.squares=null,self.tilted=null,self.Parallel=null,self.Ready=null,self.onComplete=null,self},clearCache:function(){var self=this;return self.haardata=null,self.canny=null,self.integral=null,self.squares=null,self.tilted=null,self.Selection=null,self.scaledSelection=null,self},cascade:function(haardata){return this.haardata=haardata||null,this},parallel:function(Parallel){return this.Parallel=Parallel||null,this},image:function(image,scale){var self=this;if(image){let integralImg,w,h,sw,sh,r;r=self.Ratio=undef===scale?.5:scale,self.Ready=!1,w=self.origWidth=image.width,h=self.origHeight=image.height,sw=self.width=Round(r*w),sh=self.height=Round(r*h),integralImg=integralImage(image.data,image.width,image.height),self.integral=integralImg.integral,self.squares=integralImg.squares,self.tilted=integralImg.tilted,self.canny=integralCanny(integralImg.gray,sw,sh),integralImg.gray=null,integralImg.integral=null,integralImg.squares=null,integralImg.tilted=null,integralImg=null}return self},interval:function(it){return it>0&&(this.DetectInterval=it),this},cannyThreshold:function(thres){return thres&&undef!==thres.low&&(this.cannyLow=thres.low),thres&&undef!==thres.high&&(this.cannyHigh=thres.high),this},select:function(){var args=slice.call(arguments),argslen=args.length;return 1==argslen&&"auto"==args[0]||!argslen?this.Selection=null:this.Selection=Feature[proto].data.apply(new Feature,args),this},complete:function(callback){return this.onComplete=callback||null,this},detect:function(baseScale,scale_inc,increment,min_neighbors,doCannyPruning){var selection,scaledSelection,maxScale,self=this,haardata=self.haardata,sizex=haardata.size1,sizey=haardata.size2,width=self.width,height=self.height,origWidth=self.origWidth,origHeight=self.origHeight,integral=self.integral,squares=self.squares,tilted=self.tilted,canny=self.canny,cannyLow=self.cannyLow,cannyHigh=self.cannyHigh;self.Selection||(self.Selection=new Feature(0,0,origWidth,origHeight)),(selection=self.Selection).x="auto"==selection.x?0:selection.x,selection.y="auto"==selection.y?0:selection.y,selection.width="auto"==selection.width?origWidth:selection.width,selection.height="auto"==selection.height?origHeight:selection.height,scaledSelection=self.scaledSelection=selection.clone().scale(self.Ratio).round(),baseScale=undef===baseScale?1:baseScale,scale_inc=undef===scale_inc?1.25:scale_inc,increment=undef===increment?.5:increment,min_neighbors=undef===min_neighbors?1:min_neighbors,doCannyPruning=self.doCannyPruning=undef===doCannyPruning||doCannyPruning,maxScale=self.maxScale=Min(width/sizex,height/sizey),self.scale=baseScale,self.min_neighbors=min_neighbors,self.scale_inc=scale_inc,self.increment=increment,self.Ready=!1;var parallel=self.Parallel;if(parallel&&parallel.isSupported()){var sc,data=[],i=0;for(sc=baseScale;sc<=maxScale;sc*=scale_inc)data.push({haardata:haardata,width:width,height:height,scaledSelection:{x:scaledSelection.x,y:scaledSelection.y,width:scaledSelection.width,height:scaledSelection.height},integral:integral,squares:squares,tilted:tilted,doCannyPruning:doCannyPruning,canny:doCannyPruning?canny:null,cannyLow:cannyLow,cannyHigh:cannyHigh,maxScale:maxScale,min_neighbors:min_neighbors,scale_inc:scale_inc,increment:increment,scale:sc,i:i++});new parallel(data,{synchronous:!1}).require(byOrder,detectSingleStep,mergeSteps).map(detectSingleStep).reduce(mergeSteps).then(function(rects){detectEnd(self,rects)})}else{var rects=[],detectAsync=function(){self.scale<=self.maxScale?(rects=rects.concat(detectSingleStep(self)),self.scale*=self.scale_inc,self.TimeInterval=setTimeout(detectAsync,self.DetectInterval)):(clearTimeout(self.TimeInterval),detectEnd(self,rects))};self.TimeInterval=setTimeout(detectAsync,self.DetectInterval)}return self},detectSync:function(baseScale,scale_inc,increment,min_neighbors,doCannyPruning){var scale,maxScale,self=this,sizex=self.haardata.size1,sizey=self.haardata.size2;self.Selection||(self.Selection=new Feature(0,0,self.origWidth,self.origHeight)),self.Selection.x="auto"==self.Selection.x?0:self.Selection.x,self.Selection.y="auto"==self.Selection.y?0:self.Selection.y,self.Selection.width="auto"==self.Selection.width?self.origWidth:self.Selection.width,self.Selection.height="auto"==self.Selection.height?self.origHeight:self.Selection.height,self.scaledSelection=self.Selection.clone().scale(self.Ratio).round(),baseScale=void 0===baseScale?1:baseScale,scale_inc=void 0===scale_inc?1.25:scale_inc,increment=void 0===increment?.5:increment,min_neighbors=void 0===min_neighbors?1:min_neighbors,self.doCannyPruning=void 0===doCannyPruning||doCannyPruning,maxScale=self.maxScale=Min(self.width/sizex,self.height/sizey),scale=self.scale=baseScale,self.min_neighbors=min_neighbors,self.scale_inc=scale_inc,self.increment=increment,self.Ready=!1;for(var rects=[];scale<=maxScale;)rects=rects.concat(detectSingleStep(self)),self.scale=scale*=scale_inc;for(var i=0,l=rects.length;i<l;i++)rects[i]=new Feature(rects[i]);return self.objects=merge(rects,self.min_neighbors,self.Ratio,self.Selection),self.Ready=!0,self.objects}},Detector[proto].selection=Detector[proto].select,(Feature=HAAR.Feature=function(x,y,w,h,i){this.data(x,y,w,h,i)})[proto]={constructor:Feature,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(x,y,w,h,i){var self=this;return x&&x instanceof Feature?self.copy(x):x&&x instanceof Object?(self.x=x.x||0,self.y=x.y||0,self.width=x.width||0,self.height=x.height||0,self.index=x.index||0,self.area=x.area||0,self.isInside=x.isInside||!1):(self.x=x||0,self.y=y||0,self.width=w||0,self.height=h||0,self.index=i||0,self.area=0,self.isInside=!1),self},add:function(f){var self=this;return self.x+=f.x,self.y+=f.y,self.width+=f.width,self.height+=f.height,self},scale:function(s){var self=this;return self.x*=s,self.y*=s,self.width*=s,self.height*=s,self},round:function(){var self=this;return self.x=~~(self.x+.5),self.y=~~(self.y+.5),self.width=~~(self.width+.5),self.height=~~(self.height+.5),self},computeArea:function(){var self=this;return self.area=self.width*self.height,self.area},inside:function(f){var self=this;return!!(self.x>=f.x&&self.y>=f.y&&self.x+self.width<=f.x+f.width&&self.y+self.height<=f.y+f.height)},contains:function(f){return f.inside(this)},equal:function(f){var self=this;return!(f.x!==self.x||f.y!==self.y||f.width!==self.width||f.height!==self.height)},almostEqual:function(f){var self=this,d1=.2*Max(f.width,self.width),d2=.2*Max(f.height,self.height);return!!(Abs(self.x-f.x)<=d1&&Abs(self.y-f.y)<=d2&&Abs(self.width-f.width)<=d1&&Abs(self.height-f.height)<=d2)},clone:function(){var self=this,f=new Feature;return f.x=self.x,f.y=self.y,f.width=self.width,f.height=self.height,f.index=self.index,f.area=self.area,f.isInside=self.isInside,f},copy:function(f){var self=this;return f&&f instanceof Feature&&(self.x=f.x,self.y=f.y,self.width=f.width,self.height=f.height,self.index=f.index,self.area=f.area,self.isInside=f.isInside),self},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}};